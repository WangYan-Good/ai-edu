
## 醉汉回家问题 - 马尔可夫理论

### 1 提出问题

有一个醉汉，经常去酒馆喝酒，家也离酒馆比较近，就在一条街上，走 50 步就能到家。但是由于喝醉了酒，每个时刻他可能向前走的概率是 0.4，向后走的概率是 0.4，在原地不动的概率是 0.2。

请问，他在酒馆喝醉酒后能走到家的概率是多少？

<img src="./img/RandomWalker-1.png">

图 1 醉汉回家问题示意图

图 1 是个示意图，并没有画出 50 步来，只画了 6 步。
- 起点为绿色的方框，代表酒馆；
- 终点为红色方框，代表家；
- 中间有 ABCDE 五个节点；
- 每个节点都有向前、向后、原地不动三种选择，概率用数字表示；
- 从酒馆开始允许向相反方向走；
- 到家后就不会再出来。

从表面上看，醉汉会向前一步又向后一步，然后原地愣一下......，这样的话，他从酒馆出发，永远也回不到家，因为“平均值”就在酒馆附近。

不善于理论推导的话，可以发挥计算机的优势，写一段代码来模拟这个醉汉：

```Python
import numpy as np

def RandomWalker(distance=50):
    position = 0    # 距离酒馆的位置，为50时表示到家
    counter = 0     # 行走的步数（包括原地不动）
    trajectory = [] # 行走的路径
    while(position < distance):
        # 随机选择向前(1)向后(-1)不动(0), 概率是[0.4,0.2,0.4]
        step = np.random.choice([-1,0,1], p=[0.4,0.2,0.4])
        position += step    # 更新位置
        counter += 1        # 更新步数
        trajectory.append(position) # 记录位置

    # 输出最后位置和步数，计算位置平均值
    print(position, counter, np.mean(trajectory))    

if __name__ == "__main__":
    for i in range(10):     # 试验10次
        RandomWalker(50)
```
运行上述代码，可以得到 10 次试验结果如下：
```
50 2383 22.091061686949224
50 42234 -59.706681820334325
50 11292 -23.148069429684732
50 230781 -163.41915062331822
50 7055 6.20722891566265
50 1366 11.948023426061493
50 1387 13.202595529920693
50 1742 22.126291618828933
50 5477 -5.9565455541354755
50 14322 -32.92989805893032
```
数据解读：

- 第一次试验结果表面，最终移动了 50 个单元位置到家了，走了 2383 步，历史路径的平均位置是 22。
- 第二次试验结果表面，最终移动了 50 个单元位置到家了，走了 42234 步，历史路径的平均位置是 -59.7。
......

这个结果说明了醉汉是一定可以到家的，但是步数和平均位置的方差很大。

读者在运行这个程序时，可能会得到不同的试验数据，这是正常的，因为随机过程不同。


### 2 马尔可夫性质（Markov property）

通常中文比英文更能表现出哲理来，但是在这里，我们先记住一句很有哲理的英文：

*The future is independent of the past given the present.*

**将来**只取决于**现在**，与**过去**无关。

当一个随机过程在给定当前状态及所有过去状态情况下，其未来状态的条件概率分布仅依赖于当前状态；换句话说，在给定现在状态时，它与过去状态（即该过程的历史路径）是条件独立的，那么此随机过程即具有**马尔可夫性质**。

<img src="./img/RandomWalker-2.png" width="500">

图 2 马尔可夫性质


马尔可夫性质是概率论中的一个概念，因为俄国数学家安德雷·马尔可夫得名。

用公式表示为：

$$
\mathbb P[S_{t+1}|S_t]=\mathbb P[S_{t+1}|S_1,S_2,...,S_t] \tag{1}
$$

翻译成普通话：给定当前状态 $S_t$ 时，下个状态 $S_{t+1}$ 的发生概率，等于给定以前所有状态下 $S_{t+1}$ 的发生概率。这实际上就是忽略了 $S_1, S_2, S_{t-1}$ 的存在。


在上面的图 1 中，假设醉汉到了 C 单元，但是它究竟是如何到了 C 单元的，我们并不关心，我们只知道他的下一个状态是 B,C,D 之一。

在前面的租车问题的例子中，一辆车出现在 B 门店，那么它的下一个出现点肯定是 A,C门店之一，而不管它以前曾经在哪里出现过。

从本节开始，我们把 A,B,C,D 这些门店、单元等等统称为状态，状态之间的过渡成为状态转移。状态转移的概率定义为：

$$
P_{ss'}=\mathbb P[S_{t+1}=s'|S_t=s] \tag{2}
$$

可以理解为当 $t$ 时刻的状态 $S_t$ 为 $s$ 时（$s$ 可以是上述具体问题中的 A,B,C,D 等），转移到下一个时刻 $t+1$ 时的状态 $S_{t+1}$ 是 $s'$ 的概率（$s'$ 同样可以是上述具体问题中的 A,B,C,D 等）。

举一个具体的例子，在醉汉回家问题中，如果 $s=C, s'=D$，则：

$$
P_{ss'}=P_{CD} =\mathbb P[S_{t+1}=D|S_t=C]=0.4 \tag{2}
$$

同理有：

$$
P_{CC} =\mathbb P[S_{t+1}=C|S_t=C]=0.2
\\
\\
P_{CB} =\mathbb P[S_{t+1}=B|S_t=C]=0.4\tag{3}
$$



另外，在前面的租车问题中，我们已经学习过了转移概率矩阵，这同样可以应用到马尔可夫性质中的状态转移，所以改名为状态转移矩阵（State Transition Matrix），公式形式相同，如式 4。

$$
\qquad \qquad \quad [to]
\\
P = [from]
\begin{pmatrix}
P_{11} & \cdots & P_{1n}
\\
\vdots & \ddots & \vdots
\\
P_{n1} & \cdots & P_{nn}
\end{pmatrix}
\tag{4}
$$

其中：$\sum_{j=1}^n P_{ij}=1, \ i=1,...,n$，即一行中所有的值相加为 1。


举例说明：

#### 正例

- 象棋残局
  当前盘面上的棋力、位置、先后手，决定了后面的局势发展。换一句话说，一副残局摆在那里，任何人都可以继续下棋直至结束。
- 租车还车
  车辆归还的位置只与它昨天出租的位置相关，与前天的情况无关。
- 醉汉回家
  醉汉的位置只与他上一步的位置有关，与历史足迹无关。

#### 反例

- 桥牌残局
  当前手中剩余的牌，不能让庄家决定后面如何继续打，必须依赖前面的叫牌和打牌顺序。换一句话说，打了一半的牌，别人是无法接手的，只能自己打完。

- 天气预报
  今天是晴天，明天是雨天或阴天，类似这种情况，不是严格的马尔可夫性质。因为对于气候来说，是一个长时间积累、酝酿、变化的过程。当然，也可以根据统计数据硬性计算出一个转移概率。

- 股票价格
  股价的涨跌是没有概率可言的，它是一个金融市场的规律，与股票本身以及外部环境等都关系紧密。我们常看到某些文章中说：三天大阳线，叫做三羊开泰，后市看好。假设这个描述是对的，那么明天的涨跌要依赖前三天的状态，而不是前一天的状态，这和马尔可夫性质定义不符。


### 3 马尔可夫过程（Markov Process）

具有**马尔可夫性质**的过程通常称之为**马尔可夫过程**。它是一个无记忆的随机过程，由具有马尔可夫性质的随机状态序列构成。




||时间连续|时间离散|
|-|-|-|
|**状态连续**|马尔可夫过程|N/A|
|**状态离散**|连续的马尔科夫链|马尔可夫链|

上述的醉汉回家以及租车还车的过程，都是马尔可夫   。


### 参考资料

- David Silver RL